[toc]

# 问题记录

## 2022-09-01 Flink-sql-connect-mysql-CDC 报错

```sql
Flink SQL> CREATE TABLE t_lacp_dbma_news_headlines (
>    `id` BIGINT,
>    `h_id` STRING,
>    `h_title` STRING,
>    `h_hot` STRING,
>    `h_date` STRING,
>    `create_time` TIMESTAMP,
>    `update_time` TIMESTAMP,
>    PRIMARY KEY (`id`) NOT ENFORCED
> ) WITH (
>    'connector' = 'mysql-cdc',
>    'hostname' = '125.124.239.163',
>    'port' = '3306',
>    'username' = '********',
>    'password' = '********',
>    'database-name' = 'db_lacp_dbma',
>    'table-name' = 't_lacp_dbma_news_headlines'
> );
[INFO] Execute statement succeed.

Flink SQL> select * from default_catalog.default_database.t_lacp_dbma_news_headlines limit 10;
[ERROR] Could not execute SQL statement. Reason:
java.io.StreamCorruptedException: unexpected block data
```

**报错如下**：

```txt
[ERROR] Could not execute SQL statement. Reason:
java.io.StreamCorruptedException: unexpected block data
```

**资料查找解决**

> Github: 类加载顺序问题，flink默认是child-first，在flink的flink-conf.yaml文件中添加`classloader.resolve-order: parent-first` 改成parent-first，重启集群即可。

![image-20220901142719708](问题记录.assets/image-20220901142719708.png)

**任务正常同步到ES**

```sql
-- 开启checkpoint，3秒一次
SET execution.checkpointing.interval = 3s;

-- Flink MySQL CDC 
CREATE TABLE t_lacp_dbma_news_headlines (
   `id` BIGINT,
   `h_id` STRING,
   `h_title` STRING,
   `h_hot` STRING,
   `h_date` STRING,
   `create_time` TIMESTAMP,
   `update_time` TIMESTAMP,
   PRIMARY KEY (`id`) NOT ENFORCED
) WITH (
   'connector' = 'mysql-cdc',
   'hostname' = '125.124.239.163',
   'port' = '3306',
   'username' = '********',
   'password' = '********',
   'database-name' = 'db_lacp_dbma',
   'table-name' = 't_lacp_dbma_news_headlines'
);

-- Flink ES
CREATE TABLE news_index (
   `id` BIGINT,
   `h_id` STRING,
   `h_title` STRING,
   `h_hot` STRING,
   `h_date` STRING,
   `create_time` TIMESTAMP,
   `update_time` TIMESTAMP,
   PRIMARY KEY (`id`) NOT ENFORCED
) WITH (
   'connector' = 'elasticsearch-7',
   'hosts' = 'http://localhost:9200',
   'index' = 'news_index'
);

-- sink
INSERT INTO news_index
select * from t_lacp_dbma_news_headlines;
```

![image-20220901143338057](问题记录.assets/image-20220901143338057.png)

**向mysql中插入一条数据**

![image-20220901151609632](问题记录.assets/image-20220901151609632.png)





